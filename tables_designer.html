<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Gestione Tavoli Ristorante</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

* {
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    margin: 0;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    position: relative;
}

body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="80" r="3" fill="rgba(255,255,255,0.05)"/><circle cx="40" cy="60" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="90" cy="10" r="2" fill="rgba(255,255,255,0.05)"/><circle cx="10" cy="90" r="1.5" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
    pointer-events: none;
    z-index: -1;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.3);
    animation: slideInUp 0.8s ease-out;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 25px 30px;
    position: relative;
    overflow: hidden;
}

.header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    transform: rotate(45deg);
    animation: shimmer 3s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

.header h1 {
    margin: 0 0 10px 0;
    font-size: 2em;
    font-weight: 700;
    position: relative;
    z-index: 2;
}

.header a {
    display: inline-block;
    padding: 12px 24px;
    margin: 10px 0;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    color: white;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    border: 1px solid rgba(255, 255, 255, 0.3);
    position: relative;
    z-index: 2;
}

.header a:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

.controls {
    padding: 30px;
    background: rgba(248, 250, 252, 0.8);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(226, 232, 240, 0.5);
}

.controls label {
    display: inline-block;
    margin-right: 8px;
    font-weight: 500;
    color: #4a5568;
    font-size: 0.9em;
}

.controls input, .controls select {
    margin-right: 15px;
    margin-bottom: 10px;
    padding: 10px 12px;
    border: 2px solid rgba(226, 232, 240, 0.8);
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    font-family: inherit;
    font-size: 0.9em;
    transition: all 0.3s ease;
}

.controls input:focus, .controls select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    background: rgba(255, 255, 255, 1);
}

.controls button {
    margin-right: 12px;
    margin-bottom: 8px;
    padding: 12px 20px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-family: inherit;
    font-weight: 500;
    font-size: 0.9em;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    position: relative;
    overflow: hidden;
}

.controls button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.6s;
}

.controls button:hover::before {
    left: 100%;
}

.controls button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

.controls button:active {
    transform: translateY(0);
}

.controls button:disabled {
    background: linear-gradient(135deg, #cbd5e0, #a0aec0);
    cursor: not-allowed;
    transform: none;
    box-shadow: 0 2px 8px rgba(160, 174, 192, 0.2);
}

.controls button:disabled:hover {
    transform: none;
    box-shadow: 0 2px 8px rgba(160, 174, 192, 0.2);
}

.controls button.delete {
    background: linear-gradient(135deg, #f093fb, #f5576c);
    box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
}

.controls button.delete:hover:not(:disabled) {
    box-shadow: 0 8px 25px rgba(240, 147, 251, 0.5);
}

.controls button[style*="27ae60"] {
    background: linear-gradient(135deg, #43e97b, #38f9d7) !important;
    box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);
}

.controls button[style*="27ae60"]:hover {
    box-shadow: 0 8px 25px rgba(67, 233, 123, 0.4);
}

.controls button[style*="f39c12"] {
    background: linear-gradient(135deg, #ffecd2, #fcb69f) !important;
    box-shadow: 0 4px 15px rgba(252, 182, 159, 0.3);
}

.controls button[style*="f39c12"]:hover {
    box-shadow: 0 8px 25px rgba(252, 182, 159, 0.4);
}

.controls p {
    margin: 15px 0 5px 0;
}

.canvas-container {
    display: flex;
    position: relative;
    overflow: auto;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 20px;
}

#canvas {
    border: 3px solid rgba(102, 126, 234, 0.2);
    border-radius: 15px;
    cursor: crosshair;
    display: block;
    background: rgba(255, 255, 255, 0.9);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

#canvas:hover {
    border-color: rgba(102, 126, 234, 0.4);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

#selectedTableInfoPanel {
    display: none;
    border: 2px solid rgba(240, 147, 251, 0.3);
    width: 100%;
    height: auto;
    border-radius: 15px;
    padding: 20px;
    background: rgba(248, 250, 252, 0.95);
    backdrop-filter: blur(10px);
    margin-left: 20px;
}

.info {
    padding: 25px 30px;
    background: rgba(248, 250, 252, 0.9);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(226, 232, 240, 0.5);
    font-size: 0.9em;
    color: #4a5568;
    line-height: 1.6;
}

.info strong {
    color: #2d3748;
    font-weight: 600;
}

.selected-info {
    background: rgba(67, 233, 123, 0.1);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(67, 233, 123, 0.3);
    border-radius: 12px;
    padding: 15px 20px;
    margin-top: 15px;
    display: none;
    animation: slideIn 0.5s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.selected-info strong {
    color: #22543d;
    font-weight: 600;
}

.selected-info button {
    margin-left: 10px;
    padding: 6px 12px;
    background: linear-gradient(135deg, #43e97b, #38f9d7);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-family: inherit;
    font-size: 0.8em;
    font-weight: 500;
    transition: all 0.3s ease;
}

.selected-info button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(67, 233, 123, 0.4);
}

.status-message {
    margin-top: 15px;
    padding: 15px 20px;
    border-radius: 12px;
    display: none;
    font-weight: 500;
    animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.status-success {
    background: rgba(67, 233, 123, 0.15);
    border: 2px solid rgba(67, 233, 123, 0.3);
    color: #22543d;
}

.status-error {
    background: rgba(240, 147, 251, 0.15);
    border: 2px solid rgba(240, 147, 251, 0.3);
    color: #742a2a;
}

.status-loading {
    background: rgba(252, 182, 159, 0.15);
    border: 2px solid rgba(252, 182, 159, 0.3);
    color: #744210;
}

/* File input personalizzato */
input[type="file"] {
    display: none;
}

/* Animazioni per elementi interattivi */
.controls input:hover, .controls select:hover {
    border-color: rgba(102, 126, 234, 0.5);
    transform: translateY(-1px);
}

/* Responsive design */
@media (max-width: 768px) {
    body {
        padding: 10px;
    }
    
    .container {
        border-radius: 15px;
    }
    
    .header {
        padding: 20px;
    }
    
    .header h1 {
        font-size: 1.6em;
    }
    
    .controls {
        padding: 20px;
    }
    
    .canvas-container {
        padding: 15px;
        flex-direction: column;
    }
    
    #canvas {
        width: 100%;
        height: 400px;
    }
    
    #selectedTableInfoPanel {
        margin-left: 0;
        margin-top: 20px;
    }
    
    .info {
        padding: 20px;
        font-size: 0.85em;
    }
}

/* Scrollbar personalizzata */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #764ba2, #667eea);
}

/* Effetti aggiuntivi */
.canvas-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(102, 126, 234, 0.03) 25%, transparent 25%, transparent 75%, rgba(102, 126, 234, 0.03) 75%), 
                linear-gradient(45deg, rgba(102, 126, 234, 0.03) 25%, transparent 25%, transparent 75%, rgba(102, 126, 234, 0.03) 75%);
    background-size: 20px 20px;
    background-position: 0 0, 10px 10px;
    pointer-events: none;
    opacity: 0.3;
    z-index: 0;
}

#canvas {
    position: relative;
    z-index: 1;
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>üèóÔ∏è Gestione Pianta Ristorante</h1>
<a href="dashboard.html">‚Üê Torna alla Dashboard</a>
</div>

<div class="controls">
<label>üìù Nome tavolo:</label>
<input type="text" id="tableName" placeholder="T1" value="T1" />

<label>üë• Posti:</label>
<select id="tableSeats">
<option value="2">2 posti</option>
<option value="4" selected>4 posti</option>
<option value="6">6 posti</option>
<option value="8">8 posti</option>
<option value="10">10 posti</option>
<option value="12">12 posti</option>
</select>

<label>‚ÜîÔ∏è Orientamento:</label>
<select id="tableOrientation">
<option value="horizontal">Orizzontale</option>
<option value="vertical">Verticale</option>
</select>

<p>
<button onclick="addTableMode()" id="addBtn">‚ûï Aggiungi Tavolo</button>
<button class="delete" onclick="deleteSelectedTable()" id="deleteBtn">üóëÔ∏è Elimina Selezionato</button>
<button onclick="clearCanvas()" id="clearBtn">üßπ Cancella Tutto</button>
</p>

<p>
<button onclick="saveLayout()" style="background: #27ae60;" id="saveBtn">üíæ Salva Layout</button>
<button onclick="loadLayout()" style="background: #f39c12;" id="loadBtn">üìÇ Carica Layout</button>
<button style="background: #27ae60;" onclick="exportToFile()" id="exportBtn">üì§ Esporta Layout</button>
<input type="file" id="fileInput" accept=".json" style="display: none;" onchange="importFromFile(this)" />
<button style="background: #f39c12;" onclick="document.getElementById('fileInput').click()" id="importBtn">üì• Importa Layout</button>
</p>

<div class="selected-info" id="selectedInfo">
<strong>üéØ Tavolo selezionato:</strong> <span id="selectedTableInfo"></span>
<button onclick="editSelectedTable()">‚úèÔ∏è Modifica</button>
<button onclick="toggleSelectedTableOrientation()">üîÑ Ruota</button>
<button onclick="viewSelectedTableInfo()">‚ÑπÔ∏è Info e Storico</button>
</div>

<div class="status-message" id="statusMessage"></div>
</div>

<div class="canvas-container">
<canvas id="canvas" width="800" height="500"></canvas>
<div id="selectedTableInfoPanel">
<h2>üìä Informazioni Tavolo</h2>
</div>
</div>

<div class="info">
<strong>üìã Istruzioni per l'uso:</strong><br>
‚Ä¢ <strong>Aggiungi Tavolo:</strong> Clicca il pulsante e poi clicca sulla pianta per posizionare<br>
‚Ä¢ <strong>Sposta Tavoli:</strong> Trascina i tavoli per riposizionarli<br>
‚Ä¢ <strong>Seleziona:</strong> Clicca su un tavolo per selezionarlo e vedere le opzioni<br>
‚Ä¢ <strong>Ruota:</strong> Usa "Ruota" per cambiare orientamento del tavolo selezionato<br>
‚Ä¢ <strong>Salva/Carica:</strong> Gestisci le configurazioni direttamente sul server<br>
‚Ä¢ <strong>Import/Export:</strong> Trasferisci configurazioni tramite file JSON
</div>
</div>

<script>
// Variabili di base
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let tables = [];
let selectedTable = null;
let isDragging = false;
let dragOffset = { x: 0, y: 0 };
let addingTable = false;
let isLoading = false;

// Classe Table
class Table {
constructor(x, y, name, seats, orientation='horizontal') {
this.x = x;
this.y = y;
this.name = name;
this.seats = seats;
this.orientation = orientation;
this.width = this.calculateWidth();
this.height = this.calculateHeight();
this.id = Date.now() + Math.random();
this.currentStatus = 'disponibile';
this.history = [];
}
calculateWidth() {
if (this.orientation === 'vertical') {
return Math.max(50, 40);
} else {
return Math.max(60, this.seats * 8 + 20);
}
}
calculateHeight() {
if (this.orientation === 'vertical') {
return Math.max(60, this.seats * 8 + 20);
} else {
return Math.max(50, 40);
}
}
draw() {
const isSelected = (selectedTable === this);
ctx.fillStyle = 'rgba(0,0,0,0.1)';
ctx.fillRect(this.x + 2, this.y + 2, this.width, this.height);
ctx.fillStyle = isSelected ? '#3498db' : '#8e44ad';
ctx.fillRect(this.x, this.y, this.width, this.height);
ctx.strokeStyle = isSelected ? '#2980b9' : '#7d3c98';
ctx.lineWidth = 2;
ctx.strokeRect(this.x, this.y, this.width, this.height);
ctx.fillStyle = 'white';
ctx.font = 'bold 12px Arial';
ctx.textAlign = 'center';
if (this.orientation==='vertical') {
ctx.save();
ctx.translate(this.x + this.width/2, this.y + this.height/2);
ctx.rotate(-Math.PI/2);
ctx.fillText(this.name, 0, -5);
ctx.font='10px Arial';
ctx.fillText(`${this.seats} posti`, 0, 8);
ctx.restore();
} else {
ctx.fillText(this.name, this.x + this.width/2, this.y + this.height/2 - 5);
ctx.font='10px Arial';
ctx.fillText(`${this.seats} posti`, this.x + this.width/2, this.y + this.height/2 + 8);
}
}
contains(x,y) {
return x>=this.x && x<=this.x+this.width && y>=this.y && y<=this.y+this.height;
}
updateDimensions() {
this.width=this.calculateWidth();
this.height=this.calculateHeight();
}
toggleOrientation() {
this.orientation = (this.orientation==='horizontal')?'vertical':'horizontal';
this.updateDimensions();
}
}

// Funzioni di utilit√†
function setLoadingState(loading) {
isLoading=loading;
['addBtn','deleteBtn','clearBtn','saveBtn','loadBtn','exportBtn','importBtn'].forEach(id => {
document.getElementById(id).disabled=loading;
});
}
function showStatus(msg, type='success') {
const el = document.getElementById('statusMessage');
el.textContent=msg;
el.className=`status-message status-${type}`;
el.style.display='block';
if (type!=='loading') setTimeout(()=>el.style.display='none',3000);
}
function hideStatus() {
document.getElementById('statusMessage').style.display='none';
}

// Disegno griglia e canvas
function drawGrid() {
ctx.strokeStyle='#ecf0f1';
ctx.lineWidth=1;
for (let x=0; x<canvas.width; x+=20) {
ctx.beginPath();
ctx.moveTo(x,0);
ctx.lineTo(x,canvas.height);
ctx.stroke();
}
for (let y=0; y<canvas.height; y+=20) {
ctx.beginPath();
ctx.moveTo(0,y);
ctx.lineTo(canvas.width,y);
ctx.stroke();
}
}
function drawCanvas() {
ctx.clearRect(0,0,canvas.width,canvas.height);
ctx.fillStyle='#ffffff';
ctx.fillRect(0,0,canvas.width,canvas.height);
drawGrid();
tables.forEach(t => t.draw());
if (addingTable) {
ctx.fillStyle='rgba(52,152,219,0.3)';
ctx.fillRect(0,0,canvas.width,canvas.height);
ctx.fillStyle='#2c3e50';
ctx.font='bold 16px Arial';
ctx.textAlign='center';
ctx.fillText('Clicca per posizionare il tavolo',canvas.width/2,canvas.height/2);
}
}

// Posizione mouse
function getMousePos(e) {
const rect=canvas.getBoundingClientRect();
return { x: e.clientX - rect.left, y: e.clientY - rect.top };
}
function findTableAt(x,y) {
for (let i=tables.length-1; i>=0; i--) {
if (tables[i].contains(x,y)) return tables[i];
}
return null;
}

// Selezione tavolo
function selectTable(t) {
selectedTable=t;
updateSelectedInfo();
drawCanvas();
}
function updateSelectedInfo() {
const info = document.getElementById('selectedInfo');
const infoText = document.getElementById('selectedTableInfo');
if (selectedTable) {
const orientText = selectedTable.orientation==='horizontal'?'Orizzontale':'Verticale';
infoText.textContent=`${selectedTable.name} (${selectedTable.seats} posti - ${orientText})`;
info.style.display='block';
} else {
info.style.display='none';
}
}

// Modalit√† aggiunta
function addTableMode() {
if (isLoading) return;
addingTable=true;
canvas.style.cursor='crosshair';
drawCanvas();
}
function addTable(x,y) {
const nome=document.getElementById('tableName').value || `T${tables.length+1}`;
const seats=parseInt(document.getElementById('tableSeats').value);
const orientation=document.getElementById('tableOrientation').value;
const newTable=new Table(x-30,y-20,nome,seats,orientation);
tables.push(newTable);
// Aggiorna nome automaticamente
const match=nome.match(/(\D*)(\d+)$/);
if (match) {
document.getElementById('tableName').value=match[1]+(parseInt(match[2])+1);
}
addingTable=false;
canvas.style.cursor='default';
selectTable(newTable);
drawCanvas();
}

// Cancellazione
function clearCanvas() {
if (isLoading) return;
if (confirm('Sei sicuro di voler cancellare tutti i tavoli?')) {
tables=[];
selectedTable=null;
updateSelectedInfo();
drawCanvas();
}
}
function deleteSelectedTable() {
if (isLoading) return;
if (selectedTable && confirm(`Eliminare il tavolo ${selectedTable.name}?`)) {
tables=tables.filter(t => t!==selectedTable);
selectedTable=null;
updateSelectedInfo();
drawCanvas();
}
}

// Modifica tavolo
function editSelectedTable() {
if (!selectedTable || isLoading) return;
const newName=prompt('Nome tavolo:', selectedTable.name);
if (newName !== null) { selectedTable.name=newName; }
const newSeats=prompt('Numero posti:', selectedTable.seats);
if (newSeats!==null && !isNaN(newSeats) && newSeats>0) {
selectedTable.seats=parseInt(newSeats);
selectedTable.updateDimensions();
}
updateSelectedInfo();
drawCanvas();
}
function toggleSelectedTableOrientation() {
if (!selectedTable || isLoading) return;
selectedTable.toggleOrientation();
updateSelectedInfo();
drawCanvas();
}

// Funzione richiesta: mostra tutte le info
function viewSelectedTableInfo() {
const panel = document.getElementById('selectedTableInfoPanel');
if (!selectedTable) {
panel.style.display='none';
return;
}
const t = selectedTable;
panel.innerHTML = `
<h2>Informazioni Tavolo</h2>
<p><strong>Nome:</strong> ${t.name}</p>
<p><strong>Posti:</strong> ${t.seats}</p>
<p><strong>Orientamento:</strong> ${t.orientation}</p>
<p><strong>Posizione X:</strong> ${Math.round(t.x)}</p>
<p><strong>Posizione Y:</strong> ${Math.round(t.y)}</p>
<p><strong>Larghezza:</strong> ${Math.round(t.width)}</p>
<p><strong>Altezza:</strong> ${Math.round(t.height)}</p>
<p><strong>Status attuale:</strong> ${t.currentStatus}</p>
<p><strong>Storico (ultimo stato):</strong> ${
t.history && t.history.length > 0 ? t.history[t.history.length - 1] : 'N/A'
}</p>
`;
panel.style.display='block';
}

// Aggiorna nome tavolo automaticamente
function updateNextTableName() {
if (tables.length===0) {
document.getElementById('tableName').value='T1';
return;
}
const tableNumbers=[];
tables.forEach(t => {
const match = t.name.match(/^T(\d+)$/i);
if (match) { tableNumbers.push(parseInt(match[1])); }
});
if (tableNumbers.length===0) {
document.getElementById('tableName').value='T1';
return;
}
const maxNumber=Math.max(...tableNumbers);
document.getElementById('tableName').value='T'+(maxNumber+1);
}

// Salvataggio layout
async function saveLayout() {
if (isLoading) return;
setLoadingState(true);
showStatus('Salvataggio in corso...', 'loading');
try {
const layoutData={
name: 'Layout_Ristorante',
date: new Date().toISOString(),
tables: tables.map(t => ({
x: t.x,
y: t.y,
name: t.name,
seats: t.seats,
orientation: t.orientation,
currentStatus: t.currentStatus,
history: t.history
}))
};
const response = await fetch('save_layout.php', {
method: 'POST',
headers: {
'Content-Type':'application/json',
'Cache-Control':'no-store'
},
body: JSON.stringify(layoutData)
});
const result=await response.json();
if (result.success) {
showStatus('Layout salvato con successo!', 'success');
} else {
throw new Error(result.error || 'Errore nel salvataggio');
}
} catch(e) {
showStatus('Errore nel salvataggio: ' + e.message, 'error');
}
setLoadingState(false);
}
// Carica layout
async function loadLayout() {
if (isLoading) return;
setLoadingState(true);
showStatus('Caricamento in corso...', 'loading');
try {
const response=await fetch('load_layout.php', {
method:'GET',
headers: {'Cache-Control':'no-store'}
});
const result=await response.json();
if (result.success && result.data) {
tables = result.data.tables.map(td => new Table(td.x, td.y, td.name, td.seats, td.orientation || 'horizontal', td.currentStatus || 'disponibile', td.history));
selectedTable = null;
updateSelectedInfo();
updateNextTableName();
drawCanvas();
showStatus('Layout caricato con successo!', 'success');
} else throw new Error(result.error || 'Errore nel caricamento');
} catch(e) {
showStatus('Errore nel caricamento: ' + e.message, 'error');
console.error(e);
}
setLoadingState(false);
}

// Exporta e import
function exportToFile() {
if (isLoading) return;
const layoutData={
name: prompt('Nome configurazione:', 'Layout_Ristorante') || 'Layout_Ristorante',
date: new Date().toISOString(),
tables: tables.map(t => ({
x: t.x,
y: t.y,
name: t.name,
seats: t.seats,
orientation: t.orientation,
currentStatus: t.currentStatus,
history: t.history
}))
};
const dataStr=JSON.stringify(layoutData, null, 2);
const blob=new Blob([dataStr], {type:'application/json'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download=`${layoutData.name}.json`;
a.click();
showStatus('File esportato con successo!', 'success');
}
function importFromFile(input) {
if (isLoading) return;
const file=input.files[0];
if (!file) return;
const reader=new FileReader();
reader.onload=function() {
try {
const data=JSON.parse(this.result);
if (!data.tables || !Array.isArray(data.tables)) throw new Error('Formato non valido');
tables=data.tables.map(td => new Table(td.x, td.y, td.name, td.seats, td.orientation || 'horizontal', td.currentStatus || 'disponibile', td.history));
selectedTable=null;
updateSelectedInfo();
updateNextTableName();
drawCanvas();
showStatus(`Layout "${data.name || 'Sconosciuto'}" importato con successo!`, 'success');
} catch(e) {
showStatus('Errore nell\'importazione del file: ' + e.message, 'error');
}
};
reader.readAsText(file);
input.value='';
}

// Evento e ciclo principale
canvas.addEventListener('mousedown', e => {
if (isLoading) return;
const pos=getMousePos(e);
if (addingTable) { addTable(pos.x,pos.y); return; }
const t=findTableAt(pos.x,pos.y);
if (t) {
selectTable(t);
isDragging=true;
dragOffset.x=pos.x-t.x;
dragOffset.y=pos.y-t.y;
canvas.style.cursor='move';
} else {
selectedTable=null; updateSelectedInfo(); drawCanvas();
}
});
canvas.addEventListener('mousemove', e => {
if (!isDragging || !selectedTable || isLoading) return;
const pos=getMousePos(e);
selectedTable.x=Math.max(0, Math.min(canvas.width - selectedTable.width, pos.x - dragOffset.x));
selectedTable.y=Math.max(0, Math.min(canvas.height - selectedTable.height, pos.y - dragOffset.y));
drawCanvas();
});
canvas.addEventListener('mouseup', () => { isDragging=false; canvas.style.cursor='default'; });
canvas.addEventListener('mouseleave', () => { isDragging=false; canvas.style.cursor='default'; });

window.addEventListener('load', () => {
drawCanvas();
loadLayout();
});
</script>
</body>
</html>