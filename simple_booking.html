<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Prenotazioni Ristorante</title>
<style>
body {
font-family: Arial, sans-serif;
background: #f5f6fa;
margin:0;
padding:20px;
}
.header {
background: #2c3e50;
color: white;
padding: 15px 20px;
}        
.container {
max-width:1000px;
margin:auto;
background:#fff;
border-radius:8px;
padding:20px;
box-shadow:0 2px 10px rgba(0,0,0,0.1);
}
h1 {
background:#2c3e50;
color:#fff;
padding:10px;
border-radius:6px;
}
.table-list {
width:100%;
border-collapse:collapse;
margin-top:20px;
}
.table-list th, .table-list td {
border:1px solid #ddd;
padding:10px;
text-align:center;
}
.table-list th {
background:#ecf0f1;
}
.status {
font-weight:bold;
padding:4px 8px;
border-radius:4px;
color:#fff;
}
.status.disponibile { background:#8e44ad; }
.status.prenotato { background:#f39c12; }
.status.occupato { background:#e74c3c; }
button {
padding:5px 10px;
border:none;
border-radius:4px;
cursor:pointer;
margin:2px;
}
button.info { background:#3498db; color:#fff; }
button.book { background:#27ae60; color:#fff; }
button.free { background:#e74c3c; color:#fff; }
#infoPanel {
margin-top:20px;
padding:15px;
border:1px solid #ccc;
border-radius:6px;
background:#f9f9f9;
display:none;
}
.modal {
display:none;
position:fixed;
top:0; left:0; right:0; bottom:0;
background:rgba(0,0,0,0.5);
align-items:center;
justify-content:center;
}
.modal-content {
background:#fff;
padding:20px;
border-radius:8px;
max-width:400px;
width:100%;
}
.modal-header {
display:flex;
justify-content:space-between;
border-bottom:1px solid #ddd;
padding-bottom:10px;
margin-bottom:10px;
}
.close {
cursor:pointer;
font-weight:bold;
}
label { display:block; margin-top:10px; font-weight:bold; }
input { width:100%; padding:6px; margin-top:3px; }
.actions { text-align:right; margin-top:15px; }
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>Prenotazione Ristorante</h1>
<a style="padding: 8px 12px; margin: 6px 0; border-radius: 8px; background: blue; color: white; text-decoration: none; cursor: pointer;" href="dashboard.html">Torna alla Dashboard</a>        
</div>
<button onclick="loadLayout()" style="background: #27ae60; color: white; border-radius: 8px; margin: 8px 0; padding: 8px 10px; cursor: pointer;">Aggiorna Lista Tavoli</button>
<table class="table-list" id="tableList">
<thead>
<tr>
<th>Nome</th>
<th>Capienza</th>
<th>Orientamento</th>
<th>Stato</th>
<th>Azioni</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div id="infoPanel"></div>
</div>

<!-- MODAL Prenotazione -->
<div id="bookingModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3>Assegna Prenotazione</h3>
<span class="close" onclick="closeModal()">&times;</span>
</div>
<form id="bookingForm">
<input type="hidden" id="bookingTable">
<label>Cognome:</label>
<input type="text" id="bookingName" required>
<label>Data:</label>
<input type="date" id="bookingDate" required>
<label>Ora:</label>
<input type="time" id="bookingTime" required>
<label>Numero Persone:</label>
<input type="number" id="bookingPersons" required min="1">
<div class="actions">
<button type="button" onclick="closeModal()">Annulla</button>
<button type="submit">Conferma</button>
</div>
</form>
</div>
</div>

<script>
// Variabili globali
let tables = [];
let selectedTable = null;
let autoUpdateTimer = null;
let autoUpdateEnabled = true;
let lastAutoUpdateTime = null;

// Funzione principale di caricamento layout
async function loadLayout() {
    try {
        const response = await fetch('load_layout.php', {
            method: 'GET', 
            headers: {'Cache-Control': 'no-store'}
        });
        const result = await response.json();
        if(result.success && result.data.tables) {
            tables = result.data.tables;
            renderTableList();
            console.log('‚úÖ Layout caricato con successo');
        } else {
            alert("Errore caricamento layout");
        }
    } catch(e) { 
        alert("Errore server: " + e.message); 
        console.error('‚ùå Errore caricamento:', e);
    }
}

// Caricamento silenzioso (per auto-aggiornamento)
async function loadLayoutSilently() {
    try {
        const response = await fetch('load_layout.php', {
            method: 'GET',
            headers: {'Cache-Control': 'no-store'}
        });
        const result = await response.json();
        if(result.success && result.data.tables) {
            // Mantieni il tavolo selezionato se esisteva
            const oldSelectedTableName = selectedTable ? selectedTable.name : null;
            
            tables = result.data.tables;
            renderTableList();
            
            // Ripristina la selezione
            if (oldSelectedTableName) {
                selectedTable = tables.find(t => t.name === oldSelectedTableName) || null;
                
                // Aggiorna il pannello info se era aperto
                const infoPanel = document.getElementById("infoPanel");
                if (selectedTable && infoPanel.style.display === "block") {
                    viewInfo(selectedTable.name);
                }
            }
        }
    } catch(e) { 
        console.error('‚ùå Errore caricamento silenzioso:', e);
    }
}

// Auto-aggiornamento
async function performAutoUpdate() {
    if (!autoUpdateEnabled) {
        console.log('Auto-aggiornamento saltato (disabilitato)');
        return;
    }

    try {
        console.log('üîÑ Esecuzione auto-aggiornamento...');
        
        const response = await fetch('update_table_status.php', {
            method: 'GET',
            headers: {'Cache-Control': 'no-store'}
        });

        const result = await response.json();
        
        if (result.success) {
            lastAutoUpdateTime = new Date();
            
            // Se ci sono stati aggiornamenti, ricarica il layout
            if (result.updatedTables > 0) {
                console.log(`‚úÖ Auto-aggiornamento completato: ${result.updatedTables} tavoli aggiornati`);
                await loadLayoutSilently();
                
                // Mostra notifica discreta
                showUpdateNotification(`üîÑ ${result.updatedTables} tavoli aggiornati automaticamente`);
            } else {
                console.log('‚úÖ Auto-aggiornamento completato: nessun cambiamento');
            }
        } else {
            console.warn('‚ö†Ô∏è Errore auto-aggiornamento:', result.error);
        }
    } catch (e) {
        console.error('‚ùå Errore durante auto-aggiornamento:', e);
    }
}

// Mostra notifica di aggiornamento
function showUpdateNotification(message) {
    // Crea o trova l'elemento di notifica
    let notification = document.getElementById('autoUpdateNotification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'autoUpdateNotification';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #3498db;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 14px;
            display: none;
        `;
        document.body.appendChild(notification);
    }
    
    notification.textContent = message;
    notification.style.display = 'block';
    
    // Nasconde dopo 3 secondi
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

// Gestione timer auto-aggiornamento
function startAutoUpdate() {
    if (autoUpdateTimer) {
        clearInterval(autoUpdateTimer);
    }
    
    console.log('üöÄ Avvio auto-aggiornamento (ogni 60 secondi)');
    
    // Primo aggiornamento dopo 10 secondi
    setTimeout(performAutoUpdate, 10000);
    
    // Poi ogni 60 secondi
    autoUpdateTimer = setInterval(performAutoUpdate, 60000);
}

function stopAutoUpdate() {
    if (autoUpdateTimer) {
        clearInterval(autoUpdateTimer);
        autoUpdateTimer = null;
        console.log('‚èπÔ∏è Auto-aggiornamento fermato');
    }
}

// Render della lista tavoli (migliorato)
function renderTableList() {
    const tbody = document.querySelector("#tableList tbody");
    tbody.innerHTML = "";
    
    tables.forEach(t => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${t.name}</td>
            <td>${t.seats}</td>
            <td>${t.orientation}</td>
            <td><span class="status ${t.currentStatus}">${t.currentStatus.toUpperCase()}</span></td>
            <td>
                <button class="info" onclick="viewInfo('${t.name}')">Info e Storico</button>
                <button class="book" onclick="openBooking('${t.name}')">Assegna Prenot.</button>
                <button class="free" onclick="freeTable('${t.name}')">Libera Tavolo</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Info tavolo con filtro prenotazioni future
function viewInfo(tableName) {
    const t = tables.find(tt => tt.name === tableName);
    if(!t) return;
    
    selectedTable = t; // Mantieni traccia del tavolo selezionato
    
    const now = new Date();
    let historyHtml = "<ul>";
    let hasVisibleItems = false;
    
    if (t.history && t.history.length) {
        t.history.forEach(h => {
            let shouldShow = true;
            
            // Per le prenotazioni, mostra solo quelle future
            if ((h.type === "prenotazione" || h.cognome) && h.data && h.ora) {
                try {
                    const bookingDateTime = new Date(`${h.data}T${h.ora}`);
                    shouldShow = bookingDateTime > now;
                } catch (e) {
                    console.warn('Errore parsing data:', h.data, h.ora);
                    shouldShow = true;
                }
            }
            
            if (shouldShow) {
                hasVisibleItems = true;
                
                if(typeof h === "string") {
                    historyHtml += `<li>${h}</li>`;
                } else if(h.type === "prenotazione" || h.cognome){
                    const bookingDateTime = new Date(`${h.data}T${h.ora}`);
                    const timeUntil = Math.round((bookingDateTime - now) / (1000 * 60 * 60));
                    
                    let timeInfo = '';
                    if (timeUntil > 24) {
                        const days = Math.floor(timeUntil / 24);
                        timeInfo = ` - tra ${days} giorni`;
                    } else if (timeUntil > 0) {
                        timeInfo = ` - tra ${timeUntil} ore`;
                    } else {
                        timeInfo = ' - oggi';
                    }
                    
                    historyHtml += `<li>üìù <strong>Prenotazione futura:</strong> ${h.cognome} - ${h.data} ${h.ora} (${h.persone} persone)${timeInfo}</li>`;
                } else if(h.type === "liberazione"){
                    historyHtml += `<li>üîì <strong>Tavolo liberato</strong> <small>(${h.timestamp ? new Date(h.timestamp).toLocaleString() : 'N/A'})</small></li>`;
                } else if (h.type === 'aggiornamento_automatico') {
                    historyHtml += `<li><em>üîÑ Aggiornamento automatico: ${h.old_status} ‚Üí ${h.new_status}</em> <small>(${new Date(h.timestamp).toLocaleString()})</small></li>`;
                }
            }
        });
    }
    
    if (!hasVisibleItems) {
        historyHtml = "<em>Nessuna prenotazione futura o operazione recente</em>";
    } else {
        historyHtml += "</ul>";
    }
    
    document.getElementById("infoPanel").innerHTML = `
        <h3>Info Tavolo "${t.name}"</h3>
        <p><b>Posti:</b> ${t.seats}</p>
        <p><b>Orientamento:</b> ${t.orientation}</p>
        <p><b>Status:</b> <span class="status ${t.currentStatus}">${t.currentStatus.toUpperCase()}</span></p>
        <h4>Storico Prenotazioni e Operazioni:</h4>
        ${historyHtml}
    `;
    document.getElementById("infoPanel").style.display = "block";
}

// Resto delle funzioni rimane uguale ma con logging migliorato
function openBooking(tableName) {
    const t = tables.find(tt => tt.name === tableName);
    if(!t) return;
    selectedTable = t;
    document.getElementById("bookingTable").value = t.name;
    document.getElementById("bookingPersons").max = t.seats;
    document.getElementById("bookingDate").value = new Date().toISOString().split("T")[0];
    document.getElementById("bookingModal").style.display = "flex";
}

function closeModal() {
    document.getElementById("bookingModal").style.display = "none";
}

document.getElementById("bookingForm").addEventListener("submit", async function(e){
    e.preventDefault();
    if(!selectedTable) return;

    const bookingData = {
        tableName: selectedTable.name,
        cognome: document.getElementById("bookingName").value,
        data: document.getElementById("bookingDate").value,
        ora: document.getElementById("bookingTime").value,
        persone: parseInt(document.getElementById("bookingPersons").value),
        timestamp: new Date().toISOString()
    };

    if(bookingData.persone > selectedTable.seats) {
        alert("Numero persone superiore alla capienza del tavolo");
        return;
    }

    try {
        const response = await fetch('save_booking.php',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(bookingData)
        });
        const result = await response.json();
        if(result.success) {
            selectedTable.currentStatus = result.tableStatus || "prenotato";
            if (!selectedTable.history) selectedTable.history = [];
            selectedTable.history.push(bookingData);
            renderTableList();
            viewInfo(selectedTable.name);
            closeModal();
            alert("Prenotazione salvata");
            console.log('‚úÖ Prenotazione salvata per:', selectedTable.name);
        } else { 
            alert("Errore salvataggio");
            console.error('‚ùå Errore salvataggio prenotazione');
        }
    } catch(e){ 
        alert("Errore: " + e.message);
        console.error('‚ùå Errore:', e);
    }
});

async function freeTable(tableName) {
    const t = tables.find(tt => tt.name===tableName);
    if(!t) return;
    if(!confirm(`Vuoi liberare il tavolo ${t.name}?`)) return;
    try {
        const response = await fetch('free_table.php',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({tableName:t.name})
        });
        const result = await response.json();
        if(result.success) {
            t.currentStatus = "disponibile";
            if (!t.history) t.history = [];
            t.history.push({type:"liberazione", timestamp:new Date().toISOString()});
            renderTableList();
            viewInfo(t.name);
            alert("Tavolo liberato");
            console.log('‚úÖ Tavolo liberato:', t.name);
        } else {
            alert("Errore liberazione");
            console.error('‚ùå Errore liberazione tavolo');
        }
    } catch(e){ 
        alert("Errore: " + e.message);
        console.error('‚ùå Errore:', e);
    }
}

// Gestione visibilit√† pagina
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        console.log('üì± Pagina nascosta - pausa auto-aggiornamento');
        stopAutoUpdate();
    } else {
        console.log('üì± Pagina visibile - riprendi auto-aggiornamento');
        if (autoUpdateEnabled) {
            startAutoUpdate();
            setTimeout(performAutoUpdate, 1000);
        }
    }
});

// Cleanup
window.addEventListener('beforeunload', () => {
    stopAutoUpdate();
});

// Funzione di debug (opzionale)
function getAutoUpdateStatus() {
    return {
        enabled: autoUpdateEnabled,
        timerActive: autoUpdateTimer !== null,
        lastUpdate: lastAutoUpdateTime,
        nextUpdate: autoUpdateTimer ? new Date(Date.now() + 60000) : null
    };
}

// Inizializzazione
window.addEventListener("load", () => {
    loadLayout().then(() => {
        if (autoUpdateEnabled) {
            startAutoUpdate();
        }
    });
});
</script>
</body>
</html>