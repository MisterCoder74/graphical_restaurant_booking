<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storico Prenotazioni - Sistema Gestione Ristorante</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .dashboard-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-2px);
        }
        
        .table-status-card {
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .status-available { background-color: #d4edda; border-left: 4px solid #28a745; }
        .status-booked { background-color: #fff3cd; border-left: 4px solid #ffc107; }
        .status-occupied { background-color: #f8d7da; border-left: 4px solid #dc3545; }
        
        .current-time {
            font-size: 2rem;
            font-weight: bold;
            color: #495057;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        
        .timezone-display {
            text-align: center;
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 2rem;
        }
        
        .reservations-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .status-badge {
            font-size: 0.75em;
            padding: 0.35em 0.65em;
        }
        
        .time-remaining {
            font-weight: bold;
            font-size: 0.85em;
        }
        
        .filter-section {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stats-card {
            text-align: center;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }
        
        .auto-scroll {
            scroll-behavior: smooth;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2>
                        <i class="bi bi-clock-history"></i>
                        Storico e Monitor Prenotazioni
                    </h2>
                    <div>
                        <a href="index.php" class="btn btn-outline-secondary me-2">
                            <i class="bi bi-arrow-left"></i> Torna alla Dashboard
                        </a>
                        <button class="btn btn-outline-primary" onclick="refreshData()">
                            <i class="bi bi-arrow-clockwise"></i> Aggiorna
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Current Time Display -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="current-time" id="currentTime"></div>
                <div class="timezone-display" id="timezoneDisplay"></div>
            </div>
        </div>
        
        <!-- Dashboard Cards -->
        <div class="row mb-4" id="tablesDashboard">
            <!-- Table status cards will be populated by JavaScript -->
        </div>
        
        <!-- Filters -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Filtro per Tavolo:</label>
                    <select class="form-select" id="tableFilter" onchange="applyFilters()">
                        <option value="">Tutti i tavoli</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Filtro per Ospite:</label>
                    <input type="text" class="form-control" id="guestFilter" placeholder="Nome ospite..." onkeyup="applyFilters()">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Filtro per Stato:</label>
                    <select class="form-select" id="statusFilter" onchange="applyFilters()">
                        <option value="">Tutti gli stati</option>
                        <option value="upcoming">Prossime</option>
                        <option value="occupied">Occupate</option>
                        <option value="completed">Completate</option>
                        <option value="cancelled">Cancellate</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Periodo:</label>
                    <select class="form-select" id="periodFilter" onchange="applyFilters()">
                        <option value="3">Prossimi 3 giorni</option>
                        <option value="7">Prossimi 7 giorni</option>
                        <option value="30">Prossimi 30 giorni</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Statistics Cards -->
        <div class="row mb-4" id="statsCards">
            <div class="col-md-3">
                <div class="stats-card">
                    <span class="stats-number" id="totalReservations">0</span>
                    <span>Totale Prenotazioni</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <span class="stats-number" id="activeTables">0</span>
                    <span>Tavoli Attivi</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <span class="stats-number" id="occupiedTables">0</span>
                    <span>Tavoli Occupati</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <span class="stats-number" id="todayReservations">0</span>
                    <span>Prenotazioni Oggi</span>
                </div>
            </div>
        </div>
        
        <!-- Reservations Table -->
        <div class="row">
            <div class="col-12">
                <div class="card dashboard-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-table"></i>
                            Prenotazioni 
                            <span id="reservationsCount" class="badge bg-primary ms-2">0</span>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0 reservations-table" id="reservationsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Tavolo</th>
                                        <th>Ospite</th>
                                        <th>Ospiti</th>
                                        <th>Data</th>
                                        <th>Orario</th>
                                        <th>Durata</th>
                                        <th>Stato</th>
                                        <th>Tempo Rimanente</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="reservationsTableBody">
                                    <!-- Table content will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Conferma Azione</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-danger" id="confirmButton" onclick="executeConfirmAction()">Conferma</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let allReservations = [];
        let filteredReservations = [];
        let allTables = [];
        let currentTime = new Date();
        let timezone = 'Europe/Rome'; // Set consistent timezone
        let updateInterval;
        let confirmAction = null;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure data arrays are initialized
            allReservations = [];
            filteredReservations = [];
            allTables = [];

            // Initialize statistics to 0 before loading data
            initializeStatistics();

            updateCurrentTime();
            loadLayout();
            loadReservations();
            setupAutoUpdate();

            // Update time every second
            setInterval(updateCurrentTime, 1000);
        });

        function initializeStatistics() {
            // Set all statistics to 0 on page load
            const statsIds = ['totalReservations', 'activeTables', 'occupiedTables', 'todayReservations'];
            statsIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = '0';
                }
            });
        }
        
        function updateCurrentTime() {
            // Set timezone to Europe/Rome for consistent calculations
            currentTime = new Date();
            const timeString = currentTime.toLocaleTimeString('it-IT', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: timezone
            });
            
            document.getElementById('currentTime').textContent = timeString;
            document.getElementById('timezoneDisplay').textContent = `Fuso orario: ${timezone}`;
        }
        
        async function loadLayout() {
            try {
                const response = await fetch('./php/api_layout.php?action=load&v=' + Date.now());
                const result = await response.json();

                if (result.success) {
                    // Validate and sanitize table data
                    allTables = (result.data.tables || [])
                        .filter(t => t && t.id !== undefined)
                        .map(t => ({
                            id: parseInt(t.id) || 0,
                            x: parseInt(t.x) || 0,
                            y: parseInt(t.y) || 0,
                            width: parseInt(t.width) || 120,
                            height: parseInt(t.height) || 80,
                            seats: parseInt(t.seats) || 4,
                            rotation: parseInt(t.rotation) || 0
                        }))
                        .filter(t => t.id > 0);

                    populateTableFilter();
                    updateTablesDashboard();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error loading layout:', error);
                // Initialize with empty array to prevent errors
                allTables = [];
            }
        }
        
        async function loadReservations() {
            try {
                const response = await fetch('./php/api_reservations.php?action=list&v=' + Date.now());
                const result = await response.json();

                if (result.success) {
                    // Validate and sanitize reservation data
                    allReservations = (result.data || []).map(r => ({
                        id: r.id || '',
                        tableId: parseInt(r.tableId) || 0,
                        guestName: r.guestName || 'Unknown',
                        numberOfGuests: parseInt(r.numberOfGuests) || 0,
                        date: r.date || '',
                        startTime: r.startTime || '',
                        duration: parseInt(r.duration) || 60, // Default to 60 minutes
                        status: r.status || 'upcoming',
                        createdAt: r.createdAt || '',
                        cancelledAt: r.cancelledAt || null
                    })).filter(r => r.id && r.tableId && r.date && r.startTime);

                    filteredReservations = [...allReservations];
                    applyFilters();
                    updateStatistics();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error loading reservations:', error);
                showNotification('Errore nel caricamento prenotazioni', 'danger');
                // Initialize with empty arrays to prevent errors
                allReservations = [];
                filteredReservations = [];
            }
        }
        
        function populateTableFilter() {
            const tableFilter = document.getElementById('tableFilter');
            tableFilter.innerHTML = '<option value="">Tutti i tavoli</option>';
            
            allTables.forEach(table => {
                const option = document.createElement('option');
                option.value = table.id;
                option.textContent = `Tavolo ${table.id}`;
                tableFilter.appendChild(option);
            });
        }
        
        function updateTablesDashboard() {
            const dashboard = document.getElementById('tablesDashboard');
            dashboard.innerHTML = '';

            // Ensure allTables is initialized
            if (!Array.isArray(allTables) || allTables.length === 0) {
                dashboard.innerHTML = '<div class="col-12"><p class="text-muted text-center">Nessun tavolo configurato</p></div>';
                return;
            }

            allTables.forEach(table => {
                const status = getTableCurrentStatus(table);
                const card = createTableStatusCard(table, status);
                dashboard.appendChild(card);
            });
        }
        
        function createTableStatusCard(table, status) {
            const col = document.createElement('div');
            col.className = 'col-md-2';
            
            const card = document.createElement('div');
            card.className = `table-status-card ${status.className}`;
            
            card.innerHTML = `
                <h6 class="mb-2">Tavolo ${table.id}</h6>
                <div class="badge ${status.badgeClass} status-badge">${status.text}</div>
                ${status.occupant ? `<div class="mt-2"><small><strong>${status.occupant}</strong></small></div>` : ''}
                ${status.timeRemaining ? `<div class="time-remaining mt-1">${status.timeRemaining}</div>` : ''}
            `;
            
            col.appendChild(card);
            return col;
        }
        
        function getTableCurrentStatus(table) {
            const currentDate = currentTime.toISOString().split('T')[0];
            const currentHour = currentTime.getHours();
            const currentMinute = currentTime.getMinutes();
            const currentTimeInMinutes = currentHour * 60 + currentMinute;

            // Find active reservations for this table
            const tableReservations = allReservations.filter(r =>
                r.tableId === table.id && r.status !== 'cancelled'
            );

            let status = {
                text: 'Disponibile',
                className: 'status-available',
                badgeClass: 'bg-success',
                occupant: null,
                timeRemaining: null
            };

            for (let reservation of tableReservations) {
                // Create reservation date properly handling timezone
                const [year, month, day] = reservation.date.split('-').map(Number);
                const [hour, minute] = reservation.startTime.split(':').map(Number);
                const reservationDate = new Date(year, month - 1, day, hour, minute, 0, 0);

                // Ensure duration is a valid number
                const duration = parseInt(reservation.duration) || 60; // Default to 60 minutes if invalid
                const reservationEnd = new Date(reservationDate.getTime() + duration * 60000);
                const now = currentTime;

                if (reservation.date === currentDate) {
                    if (now >= reservationDate && now <= reservationEnd) {
                        // Currently occupied
                        status = {
                            text: 'Occupato',
                            className: 'status-occupied',
                            badgeClass: 'bg-danger',
                            occupant: reservation.guestName,
                            timeRemaining: getTimeRemaining(reservationEnd)
                        };
                        break;
                    } else if (reservationDate > now) {
                        // Booked for future
                        status = {
                            text: 'Prenotato',
                            className: 'status-booked',
                            badgeClass: 'bg-warning',
                            occupant: reservation.guestName,
                            timeRemaining: 'Inizia tra ' + getTimeUntil(reservationDate)
                        };
                    }
                }
            }

            return status;
        }
        
        function getTimeRemaining(endTime) {
            const now = currentTime;
            const diff = endTime - now;
            
            if (diff <= 0) return 'Terminato';
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }
        
        function getTimeUntil(time) {
            const now = currentTime;
            const diff = time - now;
            
            if (diff <= 0) return '0m';
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }
        
        function applyFilters() {
            const tableFilter = document.getElementById('tableFilter').value;
            const guestFilter = document.getElementById('guestFilter').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const periodFilter = parseInt(document.getElementById('periodFilter').value);
            
            let filtered = [...allReservations];
            
            // Filter by table
            if (tableFilter) {
                filtered = filtered.filter(r => r.tableId == tableFilter);
            }
            
            // Filter by guest name
            if (guestFilter) {
                filtered = filtered.filter(r => 
                    r.guestName.toLowerCase().includes(guestFilter)
                );
            }
            
            // Filter by status
            if (statusFilter) {
                filtered = filtered.filter(r => r.status === statusFilter);
            }
            
            // Filter by period (next N days)
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to start of day
            
            const cutoffDate = new Date(today.getTime() + (periodFilter * 24 * 60 * 60 * 1000));
            cutoffDate.setHours(23, 59, 59, 999); // Include entire last day
            
            filtered = filtered.filter(r => {
                const reservationDate = new Date(r.date);
                reservationDate.setHours(0, 0, 0, 0); // Normalize to start of day for comparison
                const isInRange = reservationDate >= today && reservationDate <= cutoffDate;
                return isInRange;
            });
            
            // Sort by date and time
            filtered.sort((a, b) => {
                const dateA = new Date(a.date + ' ' + a.startTime);
                const dateB = new Date(b.date + ' ' + b.startTime);
                return dateA - dateB;
            });
            
            filteredReservations = filtered;
            displayReservations();
            updateStatistics();
        }
        
        function displayReservations() {
            const tbody = document.getElementById('reservationsTableBody');
            const count = document.getElementById('reservationsCount');
            
            count.textContent = filteredReservations.length;
            tbody.innerHTML = '';
            
            if (filteredReservations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            Nessuna prenotazione trovata con i filtri selezionati
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredReservations.forEach(reservation => {
                const row = createReservationRow(reservation);
                tbody.appendChild(row);
            });
            
            // Auto-scroll to current time slot
            scrollToCurrentTime();
        }
        
        function createReservationRow(reservation) {
            const row = document.createElement('tr');
            
            const status = getReservationCurrentStatus(reservation);
            const timeRemaining = getTimeRemainingForReservation(reservation);
            
            row.innerHTML = `
                <td><strong>T${reservation.tableId}</strong></td>
                <td>${reservation.guestName}</td>
                <td>${reservation.numberOfGuests}</td>
                <td>${formatDate(reservation.date)}</td>
                <td>${reservation.startTime}</td>
                <td>${reservation.duration} min</td>
                <td><span class="badge ${status.badgeClass}">${status.text}</span></td>
                <td>${timeRemaining}</td>
                <td>
                    ${getActionButtons(reservation)}
                </td>
            `;
            
            // Add pulse effect to current reservations
            if (status.current) {
                row.classList.add('pulse');
            }
            
            return row;
        }
        
        function getReservationCurrentStatus(reservation) {
            // Validate reservation data
            if (!reservation || !reservation.date || !reservation.startTime) {
                return { text: 'Dati mancanti', badgeClass: 'bg-secondary', current: false };
            }

            // Create reservation date properly handling timezone
            const [year, month, day] = reservation.date.split('-').map(Number);
            const [hour, minute] = reservation.startTime.split(':').map(Number);

            // Validate date components
            if (isNaN(year) || isNaN(month) || isNaN(day) || isNaN(hour) || isNaN(minute)) {
                return { text: 'Data non valida', badgeClass: 'bg-secondary', current: false };
            }

            const reservationDate = new Date(year, month - 1, day, hour, minute, 0, 0);

            // Ensure duration is a valid number
            const duration = parseInt(reservation.duration) || 60; // Default to 60 minutes if invalid
            const reservationEnd = new Date(reservationDate.getTime() + duration * 60000);
            const now = currentTime;

            if (reservation.status === 'cancelled') {
                return { text: 'Cancellata', badgeClass: 'bg-secondary', current: false };
            } else if (reservation.status === 'completed') {
                return { text: 'Completata', badgeClass: 'bg-info', current: false };
            } else if (now >= reservationDate && now <= reservationEnd) {
                return { text: 'In corso', badgeClass: 'bg-danger', current: true };
            } else if (reservationDate > now) {
                return { text: 'Prossima', badgeClass: 'bg-warning', current: false };
            } else {
                return { text: 'Scaduta', badgeClass: 'bg-secondary', current: false };
            }
        }
        
        function getTimeRemainingForReservation(reservation) {
            // Create reservation date properly handling timezone
            const [year, month, day] = reservation.date.split('-').map(Number);
            const [hour, minute] = reservation.startTime.split(':').map(Number);
            const reservationDate = new Date(year, month - 1, day, hour, minute, 0, 0);

            // Ensure duration is a valid number
            const duration = parseInt(reservation.duration) || 60; // Default to 60 minutes if invalid
            const reservationEnd = new Date(reservationDate.getTime() + duration * 60000);
            const now = currentTime;

            if (reservation.status === 'cancelled') {
                return '-';
            } else if (now >= reservationDate && now <= reservationEnd) {
                return getTimeRemaining(reservationEnd);
            } else if (reservationDate > now) {
                return 'Inizia tra ' + getTimeUntil(reservationDate);
            } else {
                return 'Terminata';
            }
        }
        
        function getActionButtons(reservation) {
            const now = currentTime;
            // Create reservation date properly handling timezone
            const [year, month, day] = reservation.date.split('-').map(Number);
            const [hour, minute] = reservation.startTime.split(':').map(Number);
            const reservationDate = new Date(year, month - 1, day, hour, minute, 0, 0);

            // Ensure duration is a valid number
            const duration = parseInt(reservation.duration) || 60; // Default to 60 minutes if invalid
            const reservationEnd = new Date(reservationDate.getTime() + duration * 60000);

            let buttons = '';

            if (reservation.status === 'upcoming' && now <= reservationEnd) {
                buttons += `<button class="btn btn-sm btn-outline-danger" onclick="cancelReservation('${reservation.id}')">
                    <i class="bi bi-x-circle"></i> Cancella
                </button>`;
            }

            if (reservation.status === 'upcoming' && now >= reservationDate && now <= reservationEnd) {
                buttons += `<button class="btn btn-sm btn-outline-success" onclick="markAsCompleted('${reservation.id}')">
                    <i class="bi bi-check-circle"></i> Completa
                </button>`;
            }

            return buttons || '<span class="text-muted">-</span>';
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        function scrollToCurrentTime() {
            const now = currentTime;
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            // Find row closest to current time
            let targetRow = null;
            let minDiff = Infinity;
            
            filteredReservations.forEach((reservation, index) => {
                const [hour, minute] = reservation.startTime.split(':').map(Number);
                const diff = Math.abs((hour * 60 + minute) - (currentHour * 60 + currentMinute));
                
                if (diff < minDiff) {
                    minDiff = diff;
                    targetRow = index;
                }
            });
            
            if (targetRow !== null) {
                const rows = document.querySelectorAll('#reservationsTableBody tr');
                if (rows[targetRow]) {
                    rows[targetRow].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
        
        function updateStatistics() {
            const today = new Date().toISOString().split('T')[0];

            // Ensure filteredReservations is an array
            if (!Array.isArray(filteredReservations)) {
                console.warn('filteredReservations is not an array, initializing to empty array');
                filteredReservations = [];
            }

            // Total reservations (filtered)
            document.getElementById('totalReservations').textContent = filteredReservations.length;

            // Active tables (tables with upcoming or occupied reservations)
            const activeTableIds = new Set();
            filteredReservations.forEach(r => {
                try {
                    if (r.status === 'upcoming' || getReservationCurrentStatus(r).current) {
                        const tableId = parseInt(r.tableId);
                        if (!isNaN(tableId)) {
                            activeTableIds.add(tableId);
                        }
                    }
                } catch (error) {
                    console.warn('Error calculating active table for reservation:', r, error);
                }
            });
            document.getElementById('activeTables').textContent = activeTableIds.size;

            // Occupied tables
            const occupiedTableIds = new Set();
            filteredReservations.forEach(r => {
                try {
                    const status = getReservationCurrentStatus(r);
                    if (status.current) {
                        const tableId = parseInt(r.tableId);
                        if (!isNaN(tableId)) {
                            occupiedTableIds.add(tableId);
                        }
                    }
                } catch (error) {
                    console.warn('Error calculating occupied table for reservation:', r, error);
                }
            });
            document.getElementById('occupiedTables').textContent = occupiedTableIds.size;

            // Today's reservations
            const todayReservations = filteredReservations.filter(r => r.date === today);
            document.getElementById('todayReservations').textContent = todayReservations.length;
        }
        
        async function cancelReservation(reservationId) {
            confirmAction = { type: 'cancel', id: reservationId };
            document.getElementById('confirmMessage').textContent = 
                'Sei sicuro di voler cancellare questa prenotazione?';
            
            new bootstrap.Modal(document.getElementById('confirmModal')).show();
        }
        
        async function markAsCompleted(reservationId) {
            confirmAction = { type: 'complete', id: reservationId };
            document.getElementById('confirmMessage').textContent = 
                'Contrassegnare questa prenotazione come completata?';
            
            new bootstrap.Modal(document.getElementById('confirmModal')).show();
        }
        
        async function executeConfirmAction() {
            if (!confirmAction) return;
            
            try {
                let response;
                
                if (confirmAction.type === 'cancel') {
                    response = await fetch(`./php/api_reservations.php?action=cancel&id=${confirmAction.id}`, {
                        method: 'DELETE'
                    });
                } else if (confirmAction.type === 'complete') {
                    response = await fetch('./php/api_reservations.php?action=update', {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ id: confirmAction.id, status: 'completed' })
                    });
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Operazione completata con successo', 'success');
                    loadReservations();
                    updateTablesDashboard();
                } else {
                    throw new Error(result.error);
                }
                
                bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
                confirmAction = null;
                
            } catch (error) {
                showNotification('Errore: ' + error.message, 'danger');
            }
        }
        
        async function refreshData() {
            await loadLayout();
            await loadReservations();
            showNotification('Dati aggiornati', 'info');
        }
        
        function setupAutoUpdate() {
            updateInterval = setInterval(() => {
                loadReservations();
                updateTablesDashboard();
            }, 30000); // Update every 30 seconds
        }
        
        function showNotification(message, type = 'info') {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>